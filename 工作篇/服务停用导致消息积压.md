# 服务停用导致消息积压

## 服务停用导致消息中间件消息积压，再次开启时要留心

最近在做一个核对线上数据的需求，选用的方案是应用服务器通过消息中间件把消息发给对账服务，对账服务再回调应用服务器获取对账结果，以此来解耦对账链路。

由于线上单据种类较多，考虑的场景不够周全，导致对账会把一些正常的单据识别成有问题的单据并告警，迫于无奈，只能暂时停掉对账服务，等待下次发布的时候修复对账的 bug 再重新开启。

对账 bug 被修复后，过了一个星期到了发布日，应用服务发布后，重新开启对账服务。

消息中间件积压了一个星期的消息，审核通过的一瞬间消息全打到对账服务上，对账服务再调用应用服务器，导致应用服务 QPS 升高到平时的十几倍，应用服务器疯狂 full gc，发现问题后第一时间止血，关掉了对账服务，应用服务器才慢慢恢复了正常。（幸好差的数据大多走的缓存，没有把数据库打卦）

后续 action:

1. 对账服务端丢弃较早的对账数据
2. 对应用端对账接口进行限流
3. 考虑使用离线数据库进行对账
